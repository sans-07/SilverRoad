<!DOCTYPE html>
<html>
<head>
  <title>위치 기록 + 지도 시각화 + DB 연동</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 80vh; }
  </style>
</head>
<body>
  <div style="padding: 10px; background: #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0;">내 위치 기록 + 시각화</h2>
    <div>
      <span id="user-email" style="margin-right: 15px;"></span>
      <button id="logout">로그아웃</button>
    </div>
  </div>
  <button id="start">수집 시작</button>
  <button id="stop">수집 중지</button>
  <button id="download">CSV 다운로드</button>
  <p id="status">상태: 대기 중</p>
  <div id="map"></div>


  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>


  <script>
    // --- Firebase 설정 (본인 Firebase 프로젝트 정보로 교체) ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let userLocationsCollection = null;

    // --- 인증 상태 감시 ---
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        userLocationsCollection = db.collection('users').doc(currentUser.uid).collection('locations');
        document.getElementById('user-email').innerText = `로그인: ${user.email}`;
        // 로그인 성공 시, 기존 기록 및 통계 불러오기
        loadInitialData();
      } else {
        // 로그아웃 상태이면 로그인 페이지로 이동
        window.location.href = 'login.html';
      }
    });

    // --- 지도 초기화 ---
    var map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let positionData = [];
    let polyline = L.polyline([], { color: 'blue' }).addTo(map);
    let intervalId = null;

    // 위치 한 번 수집
    function collectPosition() {
      if (!currentUser) return;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const time = new Date().toISOString();

            const point = { time, lat, lng };
            positionData.push(point);

            polyline.addLatLng([lat, lng]);
            L.marker([lat, lng]).addTo(map).bindPopup(`시간: ${time}`).openPopup();
            map.setView([lat, lng], 15);

            document.getElementById("status").innerText = `마지막 기록: ${time} / 위도:${lat}, 경도:${lng}`;

            // 사용자별 DB에 저장
            userLocationsCollection.add(point)
              .then(() => console.log("DB에 저장됨:", point))
              .catch((err) => console.error("DB 저장 오류:", err));
          },
          (err) => {
            console.error("위치 오류:", err.message);
          }
        );
      } else {
        alert("이 브라우저는 위치 정보를 지원하지 않습니다.");
      }
    }

    // CSV 변환 + 다운로드
    function downloadCSV() {
      if (positionData.length === 0) {
        alert("저장할 데이터가 없습니다.");
        return;
      }
      let csv = "time,latitude,longitude\n";
      positionData.forEach(row => {
        csv += `${row.time},${row.lat},${row.lng}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "location_data.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // 버튼 이벤트
    document.getElementById("start").addEventListener("click", () => {
      if (!intervalId) {
        collectPosition();
        intervalId = setInterval(collectPosition, 30000);
        document.getElementById("status").innerText = "상태: 수집 시작됨";
      }
    });
    document.getElementById("stop").addEventListener("click", () => {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
        document.getElementById("status").innerText = "상태: 수집 중지됨";
      }
    });
    document.getElementById("download").addEventListener("click", downloadCSV);
    document.getElementById("logout").addEventListener("click", () => {
      auth.signOut();
    });

    // --- DB에서 기존 기록 불러오기 및 통계 표시 ---
    function loadInitialData() {
      if (!userLocationsCollection) return;

      // 기존 경로 초기화
      positionData = [];
      polyline.setLatLngs([]);
      map.eachLayer(layer => {
        if (layer instanceof L.Marker || layer instanceof L.Polyline) {
           // Do not remove the tile layer
           if(layer instanceof L.TileLayer == false){
              map.removeLayer(layer);
           }
        }
      });
       polyline = L.polyline([], { color: 'blue' }).addTo(map);


      // DB에서 기록 불러오기
      userLocationsCollection.orderBy("time").get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          positionData.push(data);
          polyline.addLatLng([data.lat, data.lng]);
          L.marker([data.lat, data.lng]).addTo(map)
            .bindPopup(`시간: ${data.time}`);
        });

        // 통계 불러오기
        displayTop5Stats();
      });
    }

    // TOP 5 통계 마커 표시 함수
    async function displayTop5Stats() {
      if (!currentUser) return;
      try {
        const idToken = await currentUser.getIdToken(true);
        const response = await fetch('http://localhost:3000/api/stats', {
          headers: {
            'Authorization': `Bearer ${idToken}`
          }
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.statusText}`);
        }

        const stats = await response.json();
        const redIcon = new L.Icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        stats.forEach((item, index) => {
          const rank = index + 1;
          const { lat, lng } = item.location;
          const count = item.visitCount;

          L.marker([lat, lng], { icon: redIcon })
            .addTo(map)
            .bindPopup(`<b>자주 가는 곳 TOP ${rank}</b><br>방문 횟수: ${count}회`)
            .openPopup();
        });
      } catch (error) {
        console.error('통계 데이터 로딩 오류:', error);
      }
    }
  </script>
</body>
</html>
